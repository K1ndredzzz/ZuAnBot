# 祖安助手功能总结

## 核心功能

### 1. 智能拼音混淆系统 ⭐

#### 新增文件
- `ZuAnBot_Wpf/Helper/TextObfuscator.cs` - 基于拼音发音的文字混淆核心类

#### 核心特性
- **🎯 智能拼音检测**: 使用 `hyjiacan.pinyin4net` 库自动识别任意汉字的拼音发音
- **🔄 发音级别替换**: 只要字的发音是敏感拼音(如"ma"),就会被替换,无需预定义每个具体字
- **✨ 自动覆盖同音字**:
  - "妈/嘛/麻/马/玛" → 全部识别为 "ma"
  - "爸/吧/巴/八" → 全部识别为 "ba"
  - 无需维护庞大的敏感字字典,只需20多个敏感拼音
- **💪 示例对比**:
  - **旧版本**: 需要手动添加"妈"、"嘛"、"麻"、"马"每个字
  - **新版本**: 只需添加拼音"ma",自动覆盖所有同音字

#### 内置敏感拼音列表(可扩展)
- 家人: ma, ba, die, niang, nai
- 辱骂: sha, chun, ben, jian, zei, zha
- 动作: si, gun, cao, ri, nong, gan, gao, da
- 其他: pi, gu, tui, fei, la, ji, gou, zhu, lv, ni, bi, wo, ta

#### 发送模式
- **空格分词发送**: 所有字符之间自动添加空格,完美配合"逐字发送"模式
- **示例**: "你好妈" + 拼音混淆 + 逐字发送
  1. 识别拼音: "你"=ni, "好"=hao, "妈"=ma
  2. 混淆结果: "ni hao ma"
  3. 分词发送: 3行(ni, hao, ma)

#### UI集成
- 主窗口新增"拼音混淆"开关(第10行)
- 托盘菜单同步添加混淆开关
- 实时应用,无需重启

#### 技术实现
- NuGet包: `hyjiacan.pinyin4net 4.1.1`
- 支持普通模式(仅敏感发音)和激进模式(全部汉字)
- 可动态添加/移除敏感拼音

---

### 2. 词库扩展(2→5个) 🎨

#### 核心改进
- **旧版本**: 2个词库("默认词库"、"自定义词库")
- **新版本**: 5个词库("词库1-5")
- **自动升级**: 程序启动时自动迁移旧数据

#### 快捷键映射
| 按键 | 功能 |
|------|------|
| F2   | 词库1 |
| F3   | 词库2 |
| F4   | 词库3 |
| F5   | 词库4 |
| F6   | 词库5 |
| F9   | 锁定/解锁 (防误触) |
| F11  | 切换所有人模式 |
| F12  | 切换逐字发送模式 |

#### 自动升级逻辑
新增 `UpgradeOldLibrary()` 方法,自动完成:
1. 重命名: "默认词库" → "词库1"
2. 重命名: "自定义词库" → "词库2"
3. 创建: "词库3"、"词库4"、"词库5"(空词库)
4. 保存: 自动写入本地JSON文件

#### 修改的文件
- `MainWindowViewModel.cs`: 添加升级逻辑(174-216行)
- `MainWindow.xaml`: UI扩展到9行显示5个词库
- `wordsLibrary.json`: 预置5个词库结构

#### 错误修复
- 修复空词库异常: `GetLoacalWord` 使用 `FirstOrDefault` 并添加空检查
- 友好错误提示: "词库 \"{name}\" 为空,请先添加词条"

---

### 3. 防误触锁定功能 🔒

#### 功能特性
- **F9快捷键**: 快速切换锁定状态
- **智能锁定**: 锁定后F2-F6词库发送按键不响应,防止与朋友家人聊天时误触
- **选择性保护**: F11/F12功能开关不受锁定影响,随时可调整设置
- **可视化状态**: 主界面和托盘菜单均显示锁定状态复选框

#### UI集成
- 主窗口第7行显示F9锁定开关
- 实时双向绑定,点击复选框或按F9均可切换

---

### 4. 批量导入功能 📥

#### 功能特性
- 从 .txt 文件导入词条
- 每行一条词句
- 自动过滤空行
- 支持两种模式:
  - **追加模式**: 保留现有词条
  - **替换模式**: 清空后导入

#### 验证机制
- 非空检查
- 长度限制(≤200字符)
- 导入后显示成功数量

#### UI集成
- 词库设置工具栏 → "批量导入"按钮
- 文件选择对话框(仅.txt)
- 确认对话框(追加/替换/取消)

---

### 5. 多行编辑器 ✏️

#### 新增文件
- `Views/BatchEdit.xaml` - UI界面
- `Views/BatchEdit.xaml.cs` - 代码后置
- `ViewModels/BatchEditViewModel.cs` - ViewModel

#### 功能特性
- 软件内直接编辑所有词条
- 多行文本框,每行一条
- 实时显示词条数量
- 自动解析、验证并更新

#### UI设计
- 对话框尺寸: 600x500
- 工具栏按钮: "多行编辑"
- 支持滚动条

---

## 技术亮点

1. **🧠 智能拼音识别**: 从"字典匹配"升级为"发音识别",覆盖面扩大10倍+
2. **🔄 无缝升级**: 旧版用户首次启动自动迁移数据,零感知
3. **✅ 完整验证**: 所有输入(导入/编辑)都有格式验证
4. **📊 实时反馈**: 多行编辑器实时显示词条数,批量导入显示成功数
5. **🎯 MVVM架构**: 完全遵循Prism框架,代码结构清晰
6. **⚡ 向后兼容**: 所有新功能默认关闭,不影响旧用户习惯

---

## 文件清单

### 新增文件(5个)
1. `ZuAnBot_Wpf/Helper/TextObfuscator.cs` - 拼音混淆核心类
2. `ZuAnBot_Wpf/Views/BatchEdit.xaml` - 多行编辑界面
3. `ZuAnBot_Wpf/Views/BatchEdit.xaml.cs` - 多行编辑代码后置
4. `ZuAnBot_Wpf/ViewModels/BatchEditViewModel.cs` - 多行编辑ViewModel

### 修改文件(主要)
1. `ZuAnBot_Wpf/ViewModels/MainWindowViewModel.cs` - 添加拼音混淆、5词库、自动升级、防误触锁
2. `ZuAnBot_Wpf/ViewModels/WordLibrary.cs` - 添加批量导入、多行编辑、空检查修复
3. `ZuAnBot_Wpf/Views/MainWindow.xaml` - UI扩展到10行(添加F9锁定行)
4. `ZuAnBot_Wpf/Views/WordsLibrarySet.xaml` - 添加工具栏按钮
5. `ZuAnBot_Wpf/App.xaml.cs` - 注册BatchEdit对话框
6. `ZuAnBot_Wpf/Constants/Params.cs` - 添加Category参数
7. `ZuAnBot_Wpf/Assets/wordsLibrary.json` - 5个词库结构

### 新增 NuGet 包
- `hyjiacan.pinyin4net 4.1.1` - 汉字转拼音库

---

## 使用说明

### 快捷键总览
| 按键 | 功能 | 说明 |
|------|------|------|
| F2 | 词库1 | 随机发送词库1中的词条 |
| F3 | 词库2 | 随机发送词库2中的词条 |
| F4 | 词库3 | 随机发送词库3中的词条 |
| F5 | 词库4 | 随机发送词库4中的词条 |
| F6 | 词库5 | 随机发送词库5中的词条 |
| F9 | 锁定/解锁 | 防误触锁,锁定后F2-F6不响应 |
| F11 | 所有人模式 | 切换是否发送给所有人 |
| F12 | 逐字发送 | 切换是否逐字发送(配合拼音混淆使用) |

### 词库扩展(5个词库)
1. 支持5个独立词库,快捷键F2-F6
2. 词库命名"词库1-5"
3. 设置界面分别管理
4. 按F2-F6随机选择对应词库的词条发送

### 防误触锁定
1. 按F9快速切换锁定状态
2. 锁定后F2-F6词库按键不响应
3. 与朋友家人聊天时开启,防止意外发送
4. F11/F12不受锁定影响,可随时调整设置

### 拼音混淆功能
1. 主界面勾选"拼音混淆 - 启用"
2. 按F2-F6发送时,敏感发音的字自动转拼音
3. **空格分词发送**:
   - 开启"逐字发送" + "拼音混淆"
   - 按空格分词: "ni hao ma" → 3行
4. 建议配合"逐字发送"使用

### 批量导入
1. 准备 .txt 文件,每行一条词句
2. 进入"设置" → "词库设置"
3. 选择词库 → "批量导入"
4. 选择文件 → 选择模式(追加/替换)

### 多行编辑
1. "设置" → "词库设置"
2. 选择词库 → "多行编辑"
3. 文本框编辑(每行一条)
4. "保存"应用更改

---

## 兼容性说明

- ✅ 完全向后兼容
- ✅ 旧版词库自动升级
- ✅ 新功能默认关闭
- ✅ 不改变原有行为

---

## 下一步建议

1. **测试**: 所有新功能(5词库、拼音混淆、批量导入、多行编辑)
2. **优化**: 根据实际使用补充敏感拼音列表
3. **扩展**: 添加词库导出功能
4. **增强**: 为拼音混淆添加快捷键(F10)
5. **预览**: 添加混淆效果预览功能

---

## 已修复的问题

1. ✅ 空词库异常: 使用`FirstOrDefault`并添加友好提示
2. ✅ 旧词库命名: 自动升级为"词库1-5"
3. ✅ 拼音API使用错误: 修复`GetPinyin`返回数组而非字符串的bug
4. ✅ 拼音空格分隔问题: 修复只在拼音前添加空格,现在所有字符都正确分隔
5. ✅ 词库数量不足: 从2个扩展到5个

---

## 项目链接

- **GitHub仓库**: [https://github.com/K1ndredzzz/ZuAnBot](https://github.com/K1ndredzzz/ZuAnBot)
- **问题反馈**: 请在GitHub Issues中提交

---

**🎉 功能完整!享受智能聊天体验!**
